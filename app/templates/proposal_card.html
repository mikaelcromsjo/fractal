<%
    proposal_id = proposal.get('id', 0)
    username = proposal.get('username', '')
    user_avatar = proposal.get('avatar', '')
    proposal_date = proposal.get('date', '')
    proposal_title = proposal.get('title', '')
    proposal_message = proposal.get('message', '')
    proposal_user_id = proposal.get('user_id', proposal_id)  # Proposal author ID

    total_score = int(proposal.get('total_score') or 0)
    proposal_vote = int(proposal.get('vote') or 0)

    tags = proposal.get('tags') or []
    comments = proposal.get('comments') or []

    current_group = current_group_id if current_group_id is not None else None
    visible_count = 5
    hidden_comments_count = 0
%>

<div class="card show">
    <div class="proposal-card" data-proposal-id="${proposal_id}" data-owner="${proposal_user_id}">

        <!-- Header -->
        <div class="proposal-header-row">
            <div class="proposal-userblock">
                <img src="${user_avatar}" alt="${username}" class="proposal-avatar">
                <div class="proposal-usertext">
                    <span href="/profile/${proposal_id}/"
                       data-uid="${proposal_id}"
                       class="proposal-username usertooltip">
                        ${username}
                </span>
                    <div class="proposal-date">${proposal_date}</div>
                </div>
            </div>

            % if total_score:
            <div class="proposal-score-badge">
                ‚≠ê ${total_score}
            </div>
            % endif
        </div>

        <!-- Title + Description -->
        <div class="proposal-main">
            <h2 class="proposal-title">${proposal_title}</h2>
            <p class="proposal-text">${proposal_message}</p>

            % if tags:
                <div class="proposal-tags">
                    % for tag in tags:
                        <span class="proposal-tag">#${tag}</span>
                    % endfor
                </div>
            % endif
        </div>

        <!-- Star Rating -->
        % if proposal_vote != -1:
        <div class="proposal-rating-block">
            <div class="proposal-star-rating" id="star-rating-${proposal_id}">
                % for i in range(10):
                    <span class="star ${'active' if i < proposal_vote else 'faded'}"
                          data-rating="${i + 1}"
                          onclick="onStarRatingClick(${proposal_id}, ${i + 1})">‚≠ê</span>
                % endfor
            </div>
        </div>
        % endif

        <!-- Comments -->
        <div class="proposal-comments-block">
            <div class="proposal-comments-header">Comments</div>
            <div class="proposal-comments-list" id="comments-list-${proposal_id}">

                % if comments:
                    % for i, comment in enumerate(comments):
                        <%
                            comment_group = comment.get('group_id')
                            comment_vote = int(comment.get('vote') or 0)
                            comment_user_id = comment.get('user_id', 0)
                            is_hidden = i >= visible_count and comment_vote != 0
                            comment_total_score_raw = float(comment.get('total_score') or 0)
                            comment_total_score = int((comment_total_score_raw * 3)) if comment_total_score_raw else 0  # ‚úÖ Scale to 1-10

                        %>

                        <!-- Comment Row -->
                        <div class="proposal-comment-row ${'hidden_' + str(proposal_id) if is_hidden else ''}">
                        <!-- Comment Avatar + Hover Target -->
                            % if comment_user_id != user_id:
                            <img src="${comment.get('avatar','')}"
                                 alt="${comment.get('username','')}"
                                 class="proposal-comment-avatar vote-hover-target"
                                 data-user-id="${comment_user_id}">
                            % else:
                            <img src="${comment.get('avatar','')}"
                                 alt="${comment.get('username','')}"
                                 class="proposal-comment-avatar">
                            % endif

                            <div class="proposal-comment-content">
                                <div class="proposal-comment-top">
                                    <span>
                                        <div class="proposal-comment-username">
                                            ${comment.get('username','')}
                                        </div>
                                        <div class="proposal-comment-date">
                                            ${comment.get('date','')}
                                        </div>
                                    </span>

                                    % if comment_total_score:
                                    <div class="comment-score-badge">
                                        ‚≠ê ${comment_total_score}
                                    </div>
                                    % endif

                                    % if comment_vote != -1:
                                    <div class="comment-rating-block">
                                        <div class="comment-star-rating"
                                             id="comment-star-rating-${comment.get('id',0)}">
                                            % for j in range(3):
                                                <span class="star comment-star ${'active' if j < comment_vote else 'faded'}"
                                                      data-rating="${j + 1}"
                                                      onclick="onStarRatingCommentClick(${comment.get('id',0)}, ${j + 1})">‚≠ê</span>
                                            % endfor
                                        </div>
                                    </div>
                                    % endif
                                    
                                </div>
                                <div class="proposal-comment-text">
                                    ${comment.get('text','')}
                                </div>
                            </div>

                            <!-- Comment Author Vote Popup (if not current user) -->
                            % if comment_user_id != user_id:
                            <div class="rep-vote-popup" data-user-id="${comment_user_id}">
                                <button class="vote-btn gold" data-points="3">ü•á Gold</button>
                                <button class="vote-btn silver" data-points="2">ü•à Silver</button>
                                <button class="vote-btn bronze" data-points="1">ü•â Bronze</button>
                                <div class="user-choices">Click your #1, #2, #3</div>
                            </div>
                            % endif
                        </div>

                        <% hidden_comments_count += 1 if i >= visible_count and comment_vote != 0 else 0 %>
                    % endfor

                    % if hidden_comments_count > 0:
                    <div class="show-more-comments"
                         id="show_more_comment_proposal_${proposal_id}"
                         onclick="showHiddenComments(${proposal_id})">
                        Show ${hidden_comments_count} hidden comment${'s' if hidden_comments_count > 1 else ''}
                    </div>
                    % endif

                % else:
                    <div class="proposal-comment-empty">No comments yet.</div>
                % endif
            </div>

            <!-- Comment input -->
            <div class="proposal-comment-input-row">
                <textarea
                    class="proposal-comment-input"
                    id="comment-input-${proposal_id}"
                    rows="1"
                    placeholder="Add a comment..."
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();submitProposalComment(${proposal_id});}"></textarea>
                <button type="button"
                        class="proposal-comment-send-btn"
                        onclick="submitProposalComment(${proposal_id});">
                    Send
                </button>
            </div>
        </div>
    </div>
</div>
